<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Content transation</title>
	<meta name="viewport" content="width=device-width, minimum-scale=1.0">
	<script src="libs/jquery.js"></script>
	<script src="libs/jquery.i18n.min.js"></script>
	<script src="libs/jquery-ui.min.js"></script>
	<script src="libs/rangy-core.js"></script>
	<script src="libs/rangy-cssclassapplier.js"></script>
		<script src="libs/rangy-highlighter.js"></script>
	<script src="libs/rangy-selectionsaverestore.js"></script>
	<script src="libs/rangy-serializer.js"></script>
	<script src="libs/rangy-textrange.js"></script>
	<script src="libs/handlebars.js"></script>
	
	<link rel="stylesheet" href="libs/csswizardry-grids.css">
	<link rel="stylesheet" href="style/buttons.css">
	<link rel="stylesheet" href="style/content-translation.css">
	
	<script id="aids-template" type="text/x-handlebars-template">
			{{#if glossary}}	
			<div class="grid__item one-whole">
				<h2>{{activeWord}}</h2>
			</div>
			{{/if}}
			<div class="glossary suggestion-list">{{#each glossary}}
			<div class="description grid__item one-whole">{{{desc}}}</div>
				{{#each trans}}
				<div class="glossary suggestion grid__item">
					<span class="word">{{word}}</span>&nbsp;<span class="match">{{match}}</span>
				</div>
				{{/each}}
			{{/each}}</div>

		{{#if suggestions}}
		<div class="grid__item one-whole">
			<h2>Suggestions</h2>
		</div>
		<div class="suggestion-list">{{#each suggestions}}
			<div class="paragraph suggestion grid__item one-whole">
				{{{this}}}	
			</div>
			{{/each}}</div>
		<div class="suggestion-actions">
			<div class="paste suggestion-action grid__item one-whole">
				Use source text
			</div>
			<div class="clear suggestion-action grid__item one-whole">
				Clear translation
			</div>
		
		</div>
		{{/if}}
		
		
	</script>
	
	<script>
	lang = "es";
	suggestions = null;
	glossary = null;
	
	
	function loadData(file){
	$.getJSON('messages/content-translation/'+file+'.json',function(data) {
		suggestions=data.suggestions;
		glossary=data.glossary;
		updateTranslationAids();
	});
	
	}

/*** Glossary functions ***/
function getAllTranslationsFor(word){
	var translations=[];
	$.each(glossary, function(i,w){
		if(w.word == word){
			$.each(w.trans,function(j,t){
			translations.push(t);				
			});
		}
	});
	return translations;
}

function getAllWords(){
	var words=[];
	$.each(glossary, function(i,w){
			words.push(w.word);				
	});
	return words;
}

function getOriginalForTranslation(translation){
    var original= null;
	$.each(glossary, function(i,w){
		$.each(w.trans,function(j,t){
			if(t.word == translation){
				original = w.word;
			}			
		});
	});
	return original;
}

function getAllDifferentWords(){
	var words=[];
	$.each(glossary, function(i,w){
		if($.inArray(w,words)==-1)
			words.push(w.word);
	});
	
	$.each(words,function(i,w){
		var trans = getAllTranslationsFor(w);
		$.each(trans,function(j,t){
			if($.inArray(w,t.word)==-1)
			words.push(t.word);
		});
	});
	return words;
}

function getGlossaryMatch(word){
	var words=[];
	var original = getOriginalForTranslation(word);
	if(original!=null)
		word= original;
	
	
	if(word!=null)
	$.each(glossary, function(i,w){
		if(w.word==word)
			words.push(w);
	});
	
	
	
	return words;
}

function spanifyElement(elt){
	var words = getAllDifferentWords();
	$.each(words, function(i,w){
		spanify(elt,w);
	});
	
	$("i",elt).click(function(){
			$("i").removeClass("active");
			$(this).addClass("active");
			updateTranslationAids();
		return false;
	});
}

function spanify(elt,word){
	var text = elt.html();
	var re = new RegExp(" "+word+"(?!</i>)","g");
	text = text.replace(re, " <i>"+word+"</i>");
	elt.html(text);
}

function getWord() {
    var range = window.getSelection().getRangeAt(0);
    if (range.collapsed) {
        text = range.startContainer.textContent.substring(0, range.startOffset+1);
        return text.split(/\b/g).pop();
    }
    return '';
}

	function cursorToEnd(elt){
		var element = elt.get(0); //jquery to HTML node
	       var range = rangy.createRange();
					range.selectNodeContents(element);
					var sel = rangy.getSelection();
					sel.setSingleRange(range);
					sel.collapseToEnd();
					sel.detach();
	}

function focusOnSearchbox(){
	$(".tools .searchbox").focus();	
}

	function updateProgress(percent) {
		$(".progress .bar").css("width",percent+"%")
	}

	function updateProgressBar() {
		var pending = $(".translated.message:visible p:empty").length;	
		var total = $(".source.message:visible").length - 1;
		var val = 100*((total - pending)/ total);
		val=Math.round(val);
		updateProgress(val);
	}
	
	function adjustSize(){
		var h = $(window).height() - $(".article-panel").offset().top;
		
  			$(".article-panel").css("max-height",h);
	}
	
	function activeMessagePair(elt){
		var isAlreadyActive = elt!= null && elt.hasClass("active");
		
		if(elt!= null && !isAlreadyActive){
			$('.message-pair').removeClass("active");
			if(elt != null){
				elt.addClass("active");
				updateTranslationAids();
			}
			
		//$(".message-pair.active .message").each(function(i,e){
			//	spanifyElement($(e));
			//	});		
		}
		updateProgressBar();
	}
	
	function suggestionsForPar(par){
		var result = null;
		if(suggestions != null)
		for(var i=0; i<suggestions.length; i++){
			if(suggestions[i].p == par){
				result = suggestions[i].texts;
				break;
			}
		}
		return result;
	}
	
	function updateTranslationAids(){
		var pair = $('.message-pair.active');
		var p = pair.index();
		var trans = $(".translated p",pair);
		var isTranslationEmpty = trans.text().trim().length <= 0;
		var suggest = null;
		if(isTranslationEmpty ){
			suggest = suggestionsForPar(p);
			if( suggest != null){
				trans.html(suggest[0]);
			}
			
				$(".message-pair.active .message").each(function(i,e){
				spanifyElement($(e));
				});	
			
			
			if(trans.length){
			cursorToEnd(trans);
			}
			
		}
		//trans.focus();
		
		
		var activeWord = null;
		activeWord=$(".message-pair.active i.active").text();
		var context = {suggestions: suggestionsForPar(p), glossary:getGlossaryMatch(activeWord),activeWord:activeWord}
		var html    = aids_template(context);
		$(".context-panel .aids").html(html);
		
		//Handlers:
		$(".context-panel .paragraph.suggestion").hover(previewSuggestion,previewSuggestionClean);
		$(".context-panel .paragraph.suggestion").click(applySuggestion);
		$(".context-panel .glossary.suggestion").click(applyGlossarySuggestion);
		$('.context-panel .paste').click(pasteSource);
		$('.context-panel .clear').click(clearSuggestion);
	}
	
	function translationDone(){
		console.debug("done");
		updateProgressBar();
		var thisPair = $(this).parents(".message-pair");
		var nextPair = thisPair.next();
		activeMessagePair(nextPair);
		$(".translated p",nextPair).focus();
		//$(".translated p",nextPair).effect("highlight", {}, 500);
		return false;
	}
	
	function applyGlossarySuggestion(event){
		var elt = $(this);
		var text = $(".word", elt).text();
		var target = $(".translated.message i.active");
		if(target.length){
			target.text(text);
			$(".message-pair.active .translated.message p").focus();
			cursorToEnd(target);
		}else{
			var t = $(".message-pair.active .translated.message p");
			t.html(t.html()+" "+text);
			$(".message-pair.active .translated.message p").focus();
			cursorToEnd(t);
		}
		
		event.stopPropagation();
	}
	
	function applySuggestion(event){
		var elt = $(this);
		$("em", elt).each(function(i,e){ 
			var ref = $(e).data('ref');
			var matches=$(".message-pair.active .translated.message p em[data-ref="+ref+"]")
			$(matches).addClass('highlight');
			
			$(matches).text($(e).text());
			$(".message-pair.active .translated.message p").focus();
			cursorToEnd(matches);
			});
			event.stopPropagation();
	}
	
	function previewSuggestion(){
		var elt = $(this);
		$("em", elt).each(function(i,e){ 
			var ref = $(e).data('ref');
			var matches=$(".message-pair.active .translated.message p em[data-ref="+ref+"]")
			$(matches).addClass('highlight');
			});
	}
	
	function previewSuggestionClean(){
		$(".message-pair .translated.message em").removeClass("highlight");
	}
	
	function pasteSource(){
		var src=$(".message-pair.active .source.message p");
		var target = $(".message-pair.active .translated.message p");
		target.html(src.html());
		
		cursorToEnd(target);
		target.effect("highlight", {}, 500);
	}
	
	function clearSuggestion() {
		var target = $(".message-pair.active .translated.message p");
		target.html("");
		target.focus();
		target.effect("highlight", {}, 500);
	}
	
	
	var aids_template = Handlebars.compile($("#aids-template").html());
	
	var savedSel = null;
	
	
	$( document ).ready( function() {
		loadData(lang);
		adjustSize();
		updateProgressBar();
		
		$('p[contenteditable]').keypress(function(){
			console.debug("***");
		});
		
		$(".message-pair").click(function(){
			//savedSel = rangy.saveSelection();
			//console.debug(savedSel);	
				activeMessagePair($(this));
				//rangy.restoreSelection(savedSel);
				updateTranslationAids();
				return false;
		});
		
		$(".tools .tool.search").click(focusOnSearchbox);
		
		$(window).resize(function() {
  			adjustSize();
		});
		
		$('.translated.message p').blur(function(){
			updateProgressBar();
			
		});
		
		
		
		$(".actions .done").click(translationDone);
		
		$("body").click(function(e){
			activeMessagePair(null)
			});
			
	});
  	</script>
</head>
<body>
	


    
<div class="grid">
	<div class="logo grid__item one-third">
			   <img src="images/wikipedia-logo-landscape.png" height="60px"></img>
	</div>
	
	<div class="grid__item two-thirds">
		<div class="grid--right">
			<div class="personal-toolbar grid__item one-whole">
				  Login info	
				
			</div>
		</div>
	</div>
</div>

<div class="translation-bar grid">
	<div class="grid__item one-third">
		<span class="back-action">Translation center</span>
	</div>
	<div class="document-actions language-labels grid__item two-thirds">
		<button class="review-action btn blue">Review and publish</button>
	</div>
	
</div>

<div class="translation-area grid">
	
	<div class="article-panel grid__item two-thirds">
		<div class="grid">
			<div class="source message grid__item one-half">
				<h1>Ludwig Mies van der Rohe</h1>
			</div>
			<div class="translated message grid__item one-half">
				<h1>Ludwig Mies van der Rohe</h1>
			</div>
			
			<div class="message-pair"> <!-- 2 -->
				<div class="source message grid__item one-half">
					<p><b>Ludwig Mies van der Rohe</b> (born <b>Maria Ludwig Michael Mies</b>; March 27, 1886 – August 19, 1969) was a German-American <a href="#" title="Architect">architect</a>.<sup id="cite_ref-obit_1-0" class="reference"><a href="#cite_note-obit-1"><span>[</span>1<span>]</span></a></sup> He is commonly referred to, and was addressed, as <b>Mies</b>, his surname. He served as the last director of Berlin's <a href="/wiki/Bauhaus" title="Bauhaus">Bauhaus</a>, and then headed the department of architecture, <a href="/wiki/Illinois_Institute_of_Technology" title="Illinois Institute of Technology">Illinois Institute of Technology</a> in Chicago, where he developed the <a href="/wiki/Chicago_school_(architecture)" title="Chicago school (architecture)">Second Chicago School</a>. Along with <a href="/wiki/Le_Corbusier" title="Le Corbusier">Le Corbusier</a>, <a href="/wiki/Alvar_Aalto" title="Alvar Aalto">Alvar Aalto</a>, and <a href="/wiki/Frank_Lloyd_Wright" title="Frank Lloyd Wright">Frank Lloyd Wright</a>, he is widely regarded as one of the pioneering masters of <a href="/wiki/Modern_architecture" title="Modern architecture">modern architecture</a>.</p>
		
				</div>
				<div class="translated message grid__item one-half">
					<p contenteditable="true"></p>
					<div class="add-translation">+ Add translation</div>
					<div class="actions"><button class="done btn blue">Done</button><button class="btn disabled">Revert</button></div>
				</div>
			</div>
			<div class="message-pair">
				<div class="source message grid__item one-half">
					<p>Mies, like many of his post-<a href="/wiki/World_War_I" title="World War I">World War I</a> contemporaries, sought to establish a new architectural style that could represent modern times just as <a href="/wiki/Classical_architecture" title="Classical architecture">Classical</a> and <a href="/wiki/Gothic_architecture" title="Gothic architecture">Gothic</a> did for their own eras. He created an influential twentieth century architectural style, stated with extreme clarity and simplicity. His mature buildings made use of modern materials such as industrial steel and <a href="/wiki/Plate_glass" title="Plate glass" class="mw-redirect">plate glass</a> to define interior spaces. He strove toward an architecture with a minimal framework of structural order balanced against the implied freedom of free-flowing open space. He called his buildings "skin and bones" architecture. He sought a rational approach that would guide the creative process of architectural design, but he was always concerned with expressing the spirit of the modern era. He is often associated with his quotation of the aphorisms, "<a href="/wiki/Minimalist_architecture" title="Minimalist architecture" class="mw-redirect">less is more</a>" and "<a href="/wiki/God_is_in_the_detail" title="God is in the detail">God is in the details</a>".</p>	
				</div>
				<div class="translated message grid__item one-half"  >
					<p contenteditable="true"></p>
					<div class="add-translation">+ Add translation</div>
				</div>
			</div>
		</div>
			   
	
			   
	</div>
	<div class="context-panel source-article grid__item one-third">
				<div class="grid">
					<div class="progress grid__item one-whole"><span class="bar"></span></div>
					<div class="tools grid__item one-whole">
							<span class="tool settings"></span>
						<span class="tool search"><input type="search" class="searchbox" placeholder="Search info for a word"></input></span>

						
					</div>
				</div>
				<div class="aids grid">
					
				</div>
			   <div class="panel"></div>	
	</div>
	
</div>








</body>
</html>
  	